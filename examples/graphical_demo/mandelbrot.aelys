needs std.io
needs std.bytes
needs std.time
needs std.math
needs std.convert

let W = 160
let H = 90
let ROWS = H / 2
let MAX_ITER = 80
let ESC = convert.chr(27)
let HALF = convert.chr(9600)

@no_gc
fn run() {
    let fb = bytes.alloc(W * H)
    let pal_r = bytes.alloc(MAX_ITER + 1)
    let pal_g = bytes.alloc(MAX_ITER + 1)
    let pal_b = bytes.alloc(MAX_ITER + 1)

    for i in 0..MAX_ITER {
        let t = (i * 255) / MAX_ITER
        let mut r = 0
        let mut g = 0
        let mut b = 0
        if t < 85 {
            r = t * 3; g = 0; b = t * 3
        } else if t < 170 {
            r = 255; g = (t - 85) * 3; b = 255 - (t - 85) * 3
        } else {
            r = 255; g = 255; b = (t - 170) * 3
        }
        if r > 255 { r = 255 }
        if g > 255 { g = 255 }
        if b > 255 { b = 255 }
        bytes.write_u8(pal_r, i, r)
        bytes.write_u8(pal_g, i, g)
        bytes.write_u8(pal_b, i, b)
    }
    bytes.write_u8(pal_r, MAX_ITER, 0)
    bytes.write_u8(pal_g, MAX_ITER, 0)
    bytes.write_u8(pal_b, MAX_ITER, 0)

    io.print_inline(ESC + "[?25l")
    io.print_inline(ESC + "[2J")

    let cx = -0.745
    let cy = 0.186
    let mut zoom = 0.4

    for frame in 0..250 {
        let scale = 2.0 / zoom / H
        let ox = cx - (W / 2) * scale
        let oy = cy - (H / 2) * scale

        for py in 0..H {
            let y0 = oy + py * scale
            for px in 0..W {
                let x0 = ox + px * scale
                let mut x = 0.0
                let mut y = 0.0
                let mut i = 0
                while i < MAX_ITER and x * x + y * y <= 4.0 {
                    let xt = x * x - y * y + x0
                    y = 2.0 * x * y + y0
                    x = xt
                    i = i + 1
                }
                bytes.write_u8(fb, py * W + px, i)
            }
        }

        io.print_inline(ESC + "[H")
        for row in 0..ROWS {
            let y1 = row * 2
            let y2 = y1 + 1
            for px in 0..W {
                let i1 = bytes.read_u8(fb, y1 * W + px)
                let i2 = bytes.read_u8(fb, y2 * W + px)
                let r1 = bytes.read_u8(pal_r, i1)
                let g1 = bytes.read_u8(pal_g, i1)
                let b1 = bytes.read_u8(pal_b, i1)
                let r2 = bytes.read_u8(pal_r, i2)
                let g2 = bytes.read_u8(pal_g, i2)
                let b2 = bytes.read_u8(pal_b, i2)
                io.print_inline(ESC + "[38;2;" + convert.to_string(r1) + ";" + convert.to_string(g1) + ";" + convert.to_string(b1) + ";48;2;" + convert.to_string(r2) + ";" + convert.to_string(g2) + ";" + convert.to_string(b2) + "m" + HALF)
            }
            io.print_inline(ESC + "[0m")
            io.print("")
        }
        io.flush()

        zoom = zoom * 1.06
        time.sleep(30)
    }

    io.print_inline(ESC + "[?25h")
    io.print_inline(ESC + "[2J" + ESC + "[H")

    bytes.free(fb)
    bytes.free(pal_r)
    bytes.free(pal_g)
    bytes.free(pal_b)
}

run()
io.print("Mandelbrot zoom complete!")
